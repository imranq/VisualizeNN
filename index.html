<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>VisualizeNN</title>
	<!-- <link rel="stylesheet" href="css/normalize.css"> -->
	<!-- <link rel="shortcut icon" href="img/logo.png"> -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-grid.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- <link rel="stylesheet" href="css/foundation-icons.css"> -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.3.2/css/bootstrap-slider.css" />
	<link rel="stylesheet" href="css/index.css">
	<link rel="icon" href="favicon.png" type="image/x-icon" />



	<script src="js/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.3.2/bootstrap-slider.js"></script>
	<!-- <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script> -->
	<script src="js/num.min.js"></script>
	<script src="nn/NeuralNetwork.js"></script>
	<!-- <script src="data/mnist.js"></script> -->
	
</head>

<body>
	<nav id="navbar" class="d-flex navbar-inverse navbar justify-content-between navigation">
		<div id="logo">
		VisualizeNN | Visualization of MNIST Trained Neural Network
		</div>
		<!-- <div id="github" style="display: inline; float:right">
			See this on github <a href="www.github.com/imranq/visualizeNN">here</a>
		</div> -->
	</nav>
	<div id="container">
		<div id="info">A neural network uses linear algebra to create models from data that can predict new inputs. Backpropagation is how the weights update themselves to meet the needs of the . Includes parameters to adjust epochs, training proportions, number of layers</div>
		
		<div id="parameterWrapper" class="row">			
				<!-- <label for="layers">Epochs:</label>
				<input type="number" id="layerSelect" name="layers" min="1" max="5"> -->
				<div id="parametersTable" class="" style="width:480px">
					<div class="row" id="parameters">
						<div class="col-3">Training Set: </div>
						<input id="digits_slider" data-slider-id='digits_slider_id' type="text" data-slider-min="100" data-slider-max="5000" data-slider-step="200" data-slider-value="1000" class="col-4"/>
						<div class="col-4" id="digits_label">1000 Data Points</div>
						<div class="w-100"></div>
						<div class="col-3">Epochs: </div>
						<input id="epochs_slider" data-slider-id='epochs_slider1' type="text" data-slider-min="1" data-slider-max="10" data-slider-step="1" data-slider-value="2" class="col-6"/>
						<div class="col-4" id="epochs_label">2 Epochs</div>
						<div class="w-100"></div>
						<div class="col-3">Nodes: </div>
						<input id="nodes_slider" data-slider-id='nodes_slider1' type="text" data-slider-min="1" data-slider-max="200" data-slider-step="1" data-slider-value="100" class="col-6"/>
						<div class="col-4" id="nodes_label">100 Nodes</div>															
					</div>
				</div>
				<div id="userInteractionWrapper" class="row" style="width:600px">
						<div id="draw" class="" style="margin-left:20px; width: 20%; display: inline"></div>	
						<div id="drawWrapper" class="">	
							<button class="btn btn-info" style="vertical-align: middle" id="predictDigit">Predict Digit</button>
							<br/>Prediction: <span id="prediction" class="drawstats">--</span>
							<br/>Confidence: <span id="confidence" class="drawstats">--</span>
						</div>

						<div id="imageWrapper" class="">	
							<!-- <canvas height="28" width="28" id="dest" style="width:100px;height:100px"></canvas> -->
						</div>
				</div>
					<div class="col-2">
						<button class="btn btn-primary" id="train_btn">Train</button><br/>
						<label style="font-size:10px">(Estimated <span id="trainingEstimate">--</span> ms)</label>
					</div>
				</div>
		</div>
		
		<hr/>
		
		<div id="wrapper" class="">
			
			<!-- <div id="bpImageWrapper" class="">
				<div id="bpInputs">
					<label for="layers">Select Digit to Backquery:</label>
					<input type="number" id="layerSelect" name="layers" min="0" max="9" value="0">
					<br/>
					<button id="btn_backquery" class="btn btn-info">Generate Backquery Image</button>
				</div>
				<div id="backpropImage">
				</div>
			</div> -->
			
		</div>
		<div id="networkWrapper" class="" style="display:none">
			<div id="top" class="row">
				<div id="mnist_image">
				</div>
				<div id="hidden_layers">
				</div>
				<div id="output_matrix">
				</div>
			</div>
		</div>
		<div id="backquery" class="row">
		</div>
		
	</div> <!--container -->
	<div id="footer_bar"></div>
</body>
<script>
$(document).ready(function(){
	//visualize nn in the browser
	trainSet = 10000 //entries
	var nn = new NeuralNetwork(28*28, [100], 10, 0.2)

	function trainValue(val) {
		$("#trainDataset").text("Train on "+Math.round(trainSet*val,0)+" digit entries");
	}

	$('#digits_slider').slider();
	$('#epochs_slider').slider();
	$('#nodes_slider').slider();


	$("#digits_slider").on("slide", function(slideEvt) {
		$("#digits_label").text(slideEvt.value+" Data Points")
	});

	$("#epochs_slider").on("slide", function(slideEvt) {
		$("#epochs_label").text(slideEvt.value+" Epochs")
	});


	$("#nodes_slider").on("slide", function(slideEvt) {
		$("#nodes_label").text(slideEvt.value+" Nodes")
	});

	//set up backquery items
	for (i=0; i<10; i++) {
		if (i==5) {
			$("#backquery").append('<div class="w-100"></div>')
		}

		backquery_canvas = document.createElement('canvas');
		backquery_canvas.setAttribute('height', 28);
		backquery_canvas.setAttribute('id', 'dest_');
		$(backquery_canvas).css("background","#eee");
		$(backquery_canvas).css("width","100px");
		$(backquery_canvas).css("height","100px");
		$("#backquery").append('<div id="backquery_'+i+'" class="col"><label>'+i+"</label></div>");
		$("#backquery_"+i).append(backquery_canvas);
	}

	$("#train_btn").click(function(){
		$("#train_btn").text("Loading Data....")
		$("#train_btn").removeClass("btn-primary")
		$("#train_btn").addClass("btn-info")
		$.ajax({
			"url":"data/mnist_train_10000.csv", 
			"method": "get",
			"dataType": "text",
			"success": function( data ) {
				// console.log("Data"+data)
				//Parse data
				var record_num = 28*28+1;  // or however many elements there are in each row
			    var entries = data.split(/\r\n|\n/);

				epochs = $("#epochs_slider").val()
				nodes = $("#nodes_slider").val()
				trainingSet = $("#digits_slider").val()
				console.log(trainingSet)
				console.log(nodes)
				console.log(epochs)
				nn = new NeuralNetwork(28*28, [100], 10, 0.2)

				$("#train_btn").text("Training...")
				for (i=0; i<epochs; i++) {
					entries.slice(1,trainingSet).forEach(function(entry){
						entry = entry.split(",")
						var output = []
						for (i=0; i<10;i++) {
							output.push(0.1)
						}
						output[entry[0]] = 0.99
						mnist = entry.slice(1,785);
						for (i=0; i<mnist.length; i++) {
							// console.log(mnist[i])
							// mnist[i] = parseInt(mnist[i])
							if (mnist[i] == 0) {
								mnist[i] = 0.1
							} else if (mnist[i] > 1) {
								mnist[i] = mnist[i] / 255
							}
						}
						nn.train(mnist, output);
					})
				}
				
				$("#train_btn").removeClass("btn-info")
				$("#train_btn").addClass("btn-primary")
				$("#train_btn").text("Train")
			}
		});
	})




	$("#btn_backquery").click(function(){
		// console.log(mnist[Math.random(10)].digit)
		digit = $("#layerSelect").val()
		var reverseOutput = []
		for (i=0; i<10;i++) {
			reverseOutput.push(0.1)
		}
		reverseOutput[digit] = 0.99
		console.log(nn.backquery(reverseOutput))
	})

	$('#predictDigit').mousedown(function(e)
	{
		downscaleDim = 28
		clickX_simple = new Array();
		clickY_simple = new Array();
		clickDrag_simple = new Array();
		var image = new Image();
		image.id = "pic"
		image.src = document.getElementById('canvasSimple').toDataURL();
		canvas = document.getElementById('canvasSimple');
		ctx = canvas.getContext('2d');
		imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
		canvas_zoomed = document.createElement('canvas');
		canvas_zoomed.setAttribute('width', downscaleDim);
		canvas_zoomed.setAttribute('height', downscaleDim);
		canvas_zoomed.setAttribute('id', 'dest');
		$('#imageWrapper').html(canvas_zoomed);
		destCtx = $("#dest")[0].getContext('2d')
		newCanvas = $("<canvas>")
			.attr("width", imgData.width)
			.attr("height", imgData.height)[0]
		newCanvas.getContext('2d').putImageData(imgData,0,0)
		destCtx.scale(downscaleDim / imgData.width, downscaleDim / imgData.width)
		destCtx.drawImage(newCanvas,0,0)
		clearCanvas_simple(); 
		scaledImgData = destCtx.getImageData(0,0,downscaleDim, downscaleDim).data
		nnData = [] //28*28 sized array
		for (i=0; i<28*28; i++) {
			if (scaledImgData[i*4+3] == 0) {
				nnData.push(0.1)
			} else {
				nnData.push(scaledImgData[i*4+3]/255)
			}			
		}
		var outputs = nn.query(nnData)
		console.log(outputs)
		digit = -1
		confidence = 0
		for (i=0; i<outputs.length; i++) {
			if (outputs[i] > confidence) {
				digit = i
				confidence = outputs[i]
			}
		}

		$("#prediction").text(digit)
		$("#confidence").text(Math.round(confidence*100,2)+"%")


	});

	function displayImage(data, id) {
		canvas_zoomed = document.createElement('canvas');
		canvas_zoomed.setAttribute('width', 28);
		canvas_zoomed.setAttribute('height', 28);
		canvas_zoomed.setAttribute('id', 'dest2');
		$(canvas_zoomed).css("background","#eee");
		$(canvas_zoomed).css("width","100px");
		$(canvas_zoomed).css("height","100px");

		newImageData = new ImageData(28, 28);
		newImageData.data = new Uint8ClampedArray(3136);
		// newImageData.height = 28
		// newImageData.width = 28
		for (i=0; i<data.raw.length; i++) {
			newImageData.data[i*4] = data[i]*255;
			newImageData.data[i*4+1] = data[i]*255;
			newImageData.data[i*4+2] = data[i]*255;
			newImageData.data[i*4+3] = 255;
		}
		console.log(newImageData);

		$('#test').append(canvas_zoomed);
		$("#dest2")[0].getContext('2d').putImageData(newImageData,0,0)
		// newCanvas = $("<canvas>").attr("width", 100).attr("height", 100)[0]
		// newCanvas.getContext('2d').putImageData(newImageData,0,0)
	}
})
</script>
<script>
// var ctx = document.getElementById("probabilities").getContext('2d');
// var myChart = new Chart(ctx, {
//     type: 'bar',
//     data: {
//         labels: [0,0,0,0,0,0,0,0,0,0,0,0,0],
//         datasets: [{
//             label: 'Probability of Answer',
//             data: Array(len).fill(0)
//         }]
//     },
//     options: {
//         scales: {
//             yAxes: [{
//                 ticks: {
//                     beginAtZero:true
//                 }
//             }]
//         }
//     }
// });
</script>

<script src="js/drawCanvas.js"></script>

<script>
    page_height = $(window).height() / 5
    $("#footer_bar").css("margin-top", page_height+"px")

</script>
</html>