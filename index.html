<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>VisualizeNN | Visualize Neural Networks right in the browser</title>
	<!-- <link rel="stylesheet" href="css/normalize.css"> -->
	<!-- <link rel="shortcut icon" href="img/logo.png"> -->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/bootstrap-grid.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- <link rel="stylesheet" href="css/foundation-icons.css"> -->
	<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.3.2/css/bootstrap-slider.css" />
	<link rel="stylesheet" href="css/index.css">
	<link rel="icon" href="favicon.png" type="image/x-icon" />



	<script src="js/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/10.3.2/bootstrap-slider.js"></script>
	<!-- <script src="https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.15.1/dist/numjs.min.js"></script> -->
	<script src="js/num.min.js"></script>
	<script src="nn/NeuralNetwork.js"></script>
	<!-- <script src="data/mnist.js"></script> -->
	
</head>

<body>
	<nav id="navbar" class="navbar">
		<div id="logo" class="navbar navbar-brand">
		VisualizeNN | Visualization of MNIST Trained Neural Network
		</div>
		<a  class="nav navbar-nav navbar-right" href="https://github.com/imranq/visualizeNN" style="color:white; font-weight:bold; display:inline">
                 View on GitHub
                  <svg version="1.1" width="16" height="16" viewBox="0 0 16 16" class="octicon octicon-mark-github" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path></svg>
        </a>
	</nav>
	<div id="container">
		<div id="info">
			<p>A neural network uses nodes and edges to simulate how a "brain" learns. With linear algebra, it creates models from data. Using <a href="https://en.wikipedia.org/wiki/Backpropagation" style="color:white">Backpropagation</a>, we can use gradient descent to distribute the training errors across all the nodes and so the weights redistribute. Below you can train a 3-layer Neural Network to recognize digits. Select the size of your training set, the number of epochs, and the nodes in the hidden layer below! You can even input your own handwritten digit using the middle canvas and clicking "Predict Digit". Try it out!</p>
		</div>
		
		<div id="parameterWrapper" class="row">			
			<div id="parametersTable" class="" style="width:480px">
				<div class="row" id="parameters">
					<div class="col-3">Training Set: </div>
					<input id="digits_slider" data-slider-id='digits_slider_id' type="text" data-slider-min="100" data-slider-max="10000" data-slider-step="200" data-slider-value="100" class="col-4"/>
					<div class="col-4" id="digits_label">100 Data Points</div>
					<div class="w-100"></div>
					<div class="col-3">Epochs: </div>
					<input id="epochs_slider" data-slider-id='epochs_slider1' type="text" data-slider-min="1" data-slider-max="5" data-slider-step="1" data-slider-value="1" class="col-6"/>
					<div class="col-4" id="epochs_label">1 Epoch</div>
					<div class="w-100"></div>
					<div class="col-3">Nodes: </div>
					<input id="nodes_slider" data-slider-id='nodes_slider1' type="text" data-slider-min="10" data-slider-max="200" data-slider-step="10" data-slider-value="100" class="col-6"/>
					<div class="col-4" id="nodes_label">100 Nodes</div>															
					<div class="w-100"></div>
					<div class="tip">Tip: 6000 digits, 100 nodes, and 1 Epoch gives good results with not too much training time</div>
				</div>
			</div>
			<div id="userInteractionWrapper" class="row" style="width:600px">
					<div id="draw" class="" style="margin-left:20px; width: 20%; display: inline; margin-top: -15px; font-size: 12px">Draw a digit here:</div>	
					<div id="drawWrapper" class="">	
						<button class="btn btn-info" style="vertical-align: middle" id="predictDigit" >Predict Digit</button>
						<br/>Prediction: <span id="prediction" class="drawstats">--</span>
						<br/>Confidence: <span id="confidence" class="drawstats">--</span>
						<div class="tip">Tip: Try drawing a "2" or a "5"</div>
					</div>

					<div id="imageWrapper" class="">
						<p>Processed Drawing Shown here</p>
					</div>
			</div>
			<div class="col-2" id="nn_start">
				<button class="btn btn-primary" id="train_btn">Train Neural Network</button><br/>
				<div class="progress" id="nn_progress">
				  <div class="progress-bar bg-warning" role="progressbar" style="" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
				</div>
				<label style="font-size:10px" id="trainingEstimate"></label>
				<label id="nnConfig">Currently untrained</label>
			</div>
		</div>
		<hr/>
		<div id="networkWrapper" class="" style="display:none">
			<div id="top" class="row">
				<div id="mnist_image">
				</div>
				<div id="hidden_layers">
				</div>
				<div id="output_matrix">
				</div>
			</div>
		</div>
		<div id="backqueryWrapper" style="width: 70%; margin: 0 auto">
			<h3 >Backquery Outputs</h3><br/>
			<div id="backquery" class="row">
		
			</div>
		</div>
		
	</div> <!--container -->
	<div id="footer_bar">Created by Imran Qureshi</div>
</body>
<script>
$(document).ready(function(){
	//visualize nn in the browser
	trainSet = 10000 //entries
	var nn = new NeuralNetwork(28*28, [100], 10, 0.2)

	function trainValue(val) {
		$("#trainDataset").text("Train on "+Math.round(trainSet*val,0)+" digit entries");
	}

	$('#digits_slider').slider();
	$('#epochs_slider').slider();
	$('#nodes_slider').slider();


	$("#digits_slider").on("slide", function(slideEvt) {
		$("#digits_label").text(slideEvt.value+" Data Points")
	});

	$("#epochs_slider").on("slide", function(slideEvt) {
		$("#epochs_label").text(slideEvt.value+" Epochs")
	});


	$("#nodes_slider").on("slide", function(slideEvt) {
		$("#nodes_label").text(slideEvt.value+" Nodes")
	});

	//set up backquery items
	for (i=0; i<10; i++) {
		if (i==5) {
			$("#backquery").append('<div class="w-100"></div>')
		}

		backquery_canvas = document.createElement('canvas');
		backquery_canvas.setAttribute('height', 28);
		backquery_canvas.setAttribute('width', 28);
		backquery_canvas.setAttribute('id', 'backqueryCanvas_'+i);
		$(backquery_canvas).css("background","#eee");
		$(backquery_canvas).css("width","100px");
		$(backquery_canvas).css("height","100px");
		$("#backquery").append('<div id="backqueryWrapper_'+i+'" class="col"><label>'+i+"</label></div>");
		$("#backqueryWrapper_"+i).append(backquery_canvas);
	}

	$("#train_btn").click(function(){
		$("#train_btn").text("Loading Data....")
		$("#train_btn").removeClass("btn-primary")
		$("#train_btn").addClass("btn-info")
		$.ajax({
			"url":"data/mnist_train_10000.csv", 
			"method": "get",
			"dataType": "text",
			"success": function( data ) {
				//Parse data
				var record_num = 28*28+1;  // or however many elements there are in each row
			    var entries = data.split(/\r\n|\n/);

				epochs = parseInt($("#epochs_slider").val())
				nodes = parseInt($("#nodes_slider").val())
				trainingSet = parseInt($("#digits_slider").val())
				// console.log(trainingSet)
				// console.log(nodes)
				// console.log(epochs)

				nn = new NeuralNetwork(28*28, [nodes], 10, 0.2)

				$("#train_btn").text("Training...")
				for (e=0; e<epochs; e++) {
					var count = 0
					entries.slice(1,trainingSet).forEach(function(entry){
						entry = entry.split(",")
						var output = []
						for (i=0; i<10;i++) {
							output.push(0.1)
						}
						output[entry[0]] = 0.99
						mnist = entry.slice(1,785);
						for (i=0; i<mnist.length; i++) {
							// console.log(mnist[i])
							// mnist[i] = parseInt(mnist[i])
							if (mnist[i] == 0) {
								mnist[i] = 0.1
							} else if (mnist[i] > 1) {
								mnist[i] = mnist[i] / 255
							}
						}
						nn.train(mnist, output);
						// console.log(e+": "+count)
						if ((count == trainingSet - 3) && (e == epochs - 1)) {
							//backquery each value
							for (var j = 0; j < 10; j++) {
								target_output = []
								for (var k = 0; k < 10; k++) {
									target_output.push(0.1)
								}
								target_output[j] = 0.99
								displayImage(nn.backquery(target_output), "backqueryCanvas_"+j)
							}


							$("#train_btn").removeClass("btn-info")
							$("#train_btn").addClass("btn-primary")
							$("#train_btn").text("Train Neural Network")
						}
						count += 1
					})
				}
				
			}
		});
	})


	$("#container").css("min-height", window.innerHeight-200);

	$("#btn_backquery").click(function(){
		// console.log(mnist[Math.random(10)].digit)
		digit = $("#layerSelect").val()
		var reverseOutput = []
		for (i=0; i<10;i++) {
			reverseOutput.push(0.1)
		}
		reverseOutput[digit] = 0.99
		console.log(nn.backquery(reverseOutput))
	})

	$('#predictDigit').mousedown(function(e)
	{
		downscaleDim = 28
		clickX_simple = new Array();
		clickY_simple = new Array();
		clickDrag_simple = new Array();
		var image = new Image();
		image.id = "pic"
		image.src = document.getElementById('canvasSimple').toDataURL();
		canvas = document.getElementById('canvasSimple');
		ctx = canvas.getContext('2d');
		imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
		canvas_zoomed = document.createElement('canvas');
		canvas_zoomed.setAttribute('width', downscaleDim);
		canvas_zoomed.setAttribute('height', downscaleDim);
		canvas_zoomed.setAttribute('id', 'dest');
		$('#imageWrapper').html(canvas_zoomed);
		destCtx = $("#dest")[0].getContext('2d')
		newCanvas = $("<canvas>")
			.attr("width", imgData.width)
			.attr("height", imgData.height)[0]
		newCanvas.getContext('2d').putImageData(imgData,0,0)
		destCtx.scale(downscaleDim / imgData.width, downscaleDim / imgData.width)
		destCtx.drawImage(newCanvas,0,0)
		clearCanvas_simple(); 
		scaledImgData = destCtx.getImageData(0,0,downscaleDim, downscaleDim).data
		nnData = [] //28*28 sized array
		for (i=0; i<28*28; i++) {
			if (scaledImgData[i*4+3] == 0) {
				nnData.push(0.1)
			} else {
				nnData.push(scaledImgData[i*4+3]/255)
			}			
		}
		var outputs = nn.query(nnData)
		console.log(outputs)
		digit = -1
		confidence = 0
		for (i=0; i<outputs.length; i++) {
			if (outputs[i] > confidence) {
				digit = i
				confidence = outputs[i]
			}
		}

		$("#prediction").text(digit)
		$("#confidence").text(Math.round(confidence*100,2)+"%")


	});

	function displayImage(data, id) {
		// console.log(JSON.stringify(data))
		// console.log(id)
		canvas = document.getElementById(id)
		ctx = canvas.getContext("2d");
		newImageData = ctx.createImageData(28,28);
		for (i=0; i<data.length; i++) {
			newImageData.data[i*4] = data[i]*255;
			newImageData.data[i*4+1] = data[i]*255;
			newImageData.data[i*4+2] = data[i]*255;
			newImageData.data[i*4+3] = 255;
		}
		console.log(newImageData.data);
		ctx.putImageData(newImageData,0,0)
		// newCanvas = $("<canvas>").attr("width", 100).attr("height", 100)[0]
		// newCanvas.getContext('2d').putImageData(newImageData,0,0)
	}
})
</script>
<script>
// var ctx = document.getElementById("probabilities").getContext('2d');
// var myChart = new Chart(ctx, {
//     type: 'bar',
//     data: {
//         labels: [0,0,0,0,0,0,0,0,0,0,0,0,0],
//         datasets: [{
//             label: 'Probability of Answer',
//             data: Array(len).fill(0)
//         }]
//     },
//     options: {
//         scales: {
//             yAxes: [{
//                 ticks: {
//                     beginAtZero:true
//                 }
//             }]
//         }
//     }
// });
</script>

<script src="js/drawCanvas.js"></script>

<script>
    page_height = $(window).height() / 5
    $("#footer_bar").css("margin-top", page_height+"px")

</script>
</html>